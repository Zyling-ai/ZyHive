import{d as Ve,o as De,c,e as i,b as s,w as o,n as h,a1 as $e,aa as Ee,t as r,r as f,I as ue,A as Le,a5 as re,X as H,E as k,h as m,i as d,f as v,F as z,q as F,l as g,v as Ne,p as Z,j as K,g as P,U as ce,z as fe,ab as Me,ac as Se,a0 as Re,k as Ue,a6 as We,u as Be}from"./index-CYZvRiLL.js";import{_ as He}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Fe={class:"chats-page"},Ke={class:"page-header"},Pe={class:"filter-bar"},je={class:"filter-count"},qe={class:"row-title-cell"},Ge={class:"row-title"},Je={class:"row-id"},Oe={class:"agent-cell"},Xe={style:{"font-size":"13px","font-weight":"500"}},Qe={key:1,style:{color:"#c0c4cc"}},Ye={style:{"font-size":"12px",color:"#606266"}},Ze={style:{"font-size":"12px",color:"#909399"}},et={style:{"font-weight":"600","font-size":"15px"}},tt={style:{"font-size":"12px",color:"#909399","margin-top":"3px"}},lt={key:0,class:"drawer-loading"},at={key:1,class:"message-list"},st={class:"msg-avatar"},nt={class:"msg-body"},ot={class:"msg-meta"},it={class:"msg-role"},dt={class:"msg-time"},ut=["innerHTML"],rt={style:{flex:"1","min-width":"0"}},ct={key:0,style:{display:"flex","align-items":"center",gap:"8px"}},ft={style:{"font-weight":"600","font-size":"15px",overflow:"hidden","text-overflow":"ellipsis","white-space":"nowrap"}},pt={key:1,style:{display:"flex","align-items":"center",gap:"6px"}},mt={style:{"font-size":"12px",color:"#909399","margin-top":"3px"}},vt={key:0,class:"drawer-loading"},_t={key:1,class:"message-list"},gt={key:0,class:"compact-marker"},yt={class:"compact-summary"},ht={class:"msg-avatar"},kt={class:"msg-body"},Ct={class:"msg-meta"},wt={class:"msg-role"},bt={class:"msg-time"},xt={key:0,class:"hist-tool-timeline"},zt={class:"hist-tool-name"},It={class:"hist-tool-summary"},Tt=["innerHTML"],At={style:{display:"flex","justify-content":"flex-end",gap:"8px"}},j=50,Vt=Ve({__name:"ChatsView",setup(Dt){const pe=Be(),D=f([]),$=f(!1),I=f([]),E=f(""),C=f(""),T=f(""),L=f(""),N=f("lastAt"),ee=ue(()=>{let t=I.value;if(E.value&&(t=t.filter(a=>a.source===E.value)),C.value&&(t=t.filter(a=>a.agentId===C.value)),T.value&&(t=t.filter(a=>a.channelType===T.value)),L.value){const a=L.value.toLowerCase();t=t.filter(u=>(u.title||"").toLowerCase().includes(a)||(u.channelId||"").toLowerCase().includes(a)||u.id.toLowerCase().includes(a)||u.agentName.toLowerCase().includes(a))}const e=[...t];return N.value==="messageCount"?e.sort((a,u)=>u.messageCount-a.messageCount):N.value==="tokenEstimate"?e.sort((a,u)=>(u.tokenEstimate||0)-(a.tokenEstimate||0)):e.sort((a,u)=>u.lastAt-a.lastAt),e}),me=ue(()=>{const t={};return D.value.forEach(e=>{t[e.id]=e.avatarColor||"#6366f1"}),t});async function M(){$.value=!0;try{const[t,e,a]=await Promise.all([Le.list().catch(()=>({data:[]})),re.globalList({agentId:C.value||void 0,channelType:T.value||void 0}).catch(()=>({data:[]})),H.list({agentId:C.value||void 0,limit:300}).catch(()=>({data:{sessions:[],total:0}}))]);D.value=t.data||[];const u={};D.value.forEach(n=>{u[n.id]=n.name});const b=(e.data||[]).map(n=>({source:"channel",id:n.channelId,agentId:n.agentId,agentName:n.agentName||u[n.agentId]||n.agentId,messageCount:n.messageCount,lastAt:typeof n.lastAt=="string"?new Date(n.lastAt).getTime():n.lastAt,firstAt:typeof n.firstAt=="string"?new Date(n.firstAt).getTime():n.firstAt,channelType:n.channelType,channelId:n.channelId,_channel:n})),W=(a.data?.sessions||[]).filter(n=>!n.id.startsWith("subagent-")&&!n.id.startsWith("goal-")&&!n.id.startsWith("__")).map(n=>({source:"session",id:n.id,agentId:n.agentId,agentName:n.agentName||u[n.agentId]||n.agentId,messageCount:n.messageCount,lastAt:typeof n.lastAt=="string"?new Date(n.lastAt).getTime():n.lastAt||0,createdAt:typeof n.createdAt=="string"?new Date(n.createdAt).getTime():n.createdAt||0,title:n.title,tokenEstimate:n.tokenEstimate,_session:n}));I.value=[...b,...W]}catch{k.error("加载失败")}finally{$.value=!1}}function te(t){t.source==="channel"&&t._channel?_e(t._channel):t.source==="session"&&t._session&&ye(t._session)}function ve({row:t}){return t.source==="session"&&t._session&&p.value?.id===t._session.id?"active-row":""}const q=f(!1),y=f(null),G=f([]),J=f(!1),O=f(0),X=f(1);async function _e(t){y.value=t,q.value=!0,X.value=1,await le(t,1)}async function le(t,e){J.value=!0;try{const a=(e-1)*j,u=await re.messages(t.agentId,t.channelId,{limit:j,offset:a});G.value=u.data.messages||[],O.value=u.data.total}catch{k.error("加载消息失败")}finally{J.value=!1}}async function ge(t){X.value=t,y.value&&await le(y.value,t)}const A=f(!1),p=f(null),S=f([]),R=f(!1),V=f(!1),w=f("");async function ye(t){p.value=t,A.value=!0,V.value=!1,S.value=[],R.value=!0;try{const e=await H.get(t.agentId,t.id);S.value=e.data.messages}catch{k.error("加载对话失败")}finally{R.value=!1}}function ae(t){t&&pe.push(`/agents/${t.agentId}?resumeSession=${t.id}`)}async function he(t){if(t._session)try{await H.delete(t._session.agentId,t._session.id),k.success("已删除"),p.value?.id===t._session.id&&(A.value=!1),I.value=I.value.filter(e=>e.id!==t.id||e.source!=="session")}catch{k.error("删除失败")}}function ke(){w.value=p.value?.title||"",V.value=!0}async function se(){if(p.value)try{await H.rename(p.value.agentId,p.value.id,w.value),p.value.title=w.value;const t=I.value.find(e=>e.source==="session"&&e.id===p.value.id);t&&(t.title=w.value),V.value=!1,k.success("已重命名")}catch{k.error("保存失败")}}function Ce(t,e){try{const a=JSON.parse(e);if(t==="bash"||t==="exec")return(a.command??"").slice(0,40);if(t==="read"||t==="write")return(a.path??a.file_path??"").split("/").pop()??"";if(t==="agent_spawn")return`→ ${a.agentId??"?"}: ${(a.task??"").slice(0,30)}…`;if(t==="web_search")return(a.query??"").slice(0,40)}catch{}return e.slice(0,40)}function U(t){return t?(typeof t=="string"?new Date(t):new Date(t)).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"—"}function we(t){if(!t)return"—";const e=typeof t=="string"?new Date(t).getTime():t,a=Date.now()-e;return a<6e4?"刚刚":a<36e5?`${Math.floor(a/6e4)} 分钟前`:a<864e5?`${Math.floor(a/36e5)} 小时前`:a<7*864e5?`${Math.floor(a/864e5)} 天前`:U(e)}function ne(t){return t?t>=1e3?`${(t/1e3).toFixed(1)}k`:String(t):"0"}function oe(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```[\s\S]*?```/g,e=>`<pre class="code-block">${e.slice(3,-3)}</pre>`).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>")}return De(()=>M()),(t,e)=>{const a=m("el-button"),u=m("el-option"),b=m("el-select"),W=m("el-input"),n=m("el-tag"),_=m("el-table-column"),be=m("el-popconfirm"),Q=m("el-empty"),xe=m("el-table"),ze=m("el-card"),Y=m("el-icon"),ie=m("el-avatar"),Ie=m("el-pagination"),de=m("el-drawer"),Te=m("el-divider"),Ae=We("loading");return d(),c("div",Fe,[i("div",Ke,[e[14]||(e[14]=i("div",null,[i("h2",{style:{margin:"0"}},"对话管理"),i("div",{style:{"font-size":"13px",color:"#909399","margin-top":"2px"}},"所有渠道对话与面板会话统一视图")],-1)),s(a,{loading:$.value,icon:h($e),onClick:M},{default:o(()=>[...e[13]||(e[13]=[v("刷新",-1)])]),_:1},8,["loading","icon"])]),i("div",Pe,[s(b,{modelValue:E.value,"onUpdate:modelValue":e[0]||(e[0]=l=>E.value=l),placeholder:"全部类型",clearable:"",size:"small",style:{width:"130px"}},{default:o(()=>[s(u,{label:"渠道对话",value:"channel"}),s(u,{label:"面板会话",value:"session"})]),_:1},8,["modelValue"]),s(b,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=l=>C.value=l),placeholder:"全部成员",clearable:"",size:"small",style:{width:"140px"},onChange:M},{default:o(()=>[(d(!0),c(z,null,F(D.value,l=>(d(),g(u,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(b,{modelValue:T.value,"onUpdate:modelValue":e[2]||(e[2]=l=>T.value=l),placeholder:"全部渠道",clearable:"",size:"small",style:{width:"130px"},onChange:M},{default:o(()=>[s(u,{label:"Telegram",value:"telegram"}),s(u,{label:"Web 聊天",value:"web"})]),_:1},8,["modelValue"]),s(W,{modelValue:L.value,"onUpdate:modelValue":e[3]||(e[3]=l=>L.value=l),placeholder:"搜索标题 / ID / 成员…",clearable:"",size:"small",style:{width:"220px"},"prefix-icon":h(Ee)},null,8,["modelValue","prefix-icon"]),s(b,{modelValue:N.value,"onUpdate:modelValue":e[4]||(e[4]=l=>N.value=l),size:"small",style:{width:"120px"}},{default:o(()=>[s(u,{label:"最近活跃",value:"lastAt"}),s(u,{label:"消息最多",value:"messageCount"}),s(u,{label:"Token 最多",value:"tokenEstimate"})]),_:1},8,["modelValue"]),i("span",je,"共 "+r(ee.value.length)+" 条",1)]),s(ze,{shadow:"never",class:"list-card"},{default:o(()=>[Ne((d(),g(xe,{data:ee.value,stripe:"",onRowClick:te,style:{cursor:"pointer"},"row-class-name":ve,size:"default"},{empty:o(()=>[s(Q,{description:"暂无对话记录"})]),default:o(()=>[s(_,{label:"类型",width:"90",align:"center"},{default:o(({row:l})=>[l.source==="channel"?(d(),g(n,{key:0,type:l.channelType==="telegram"?"success":"warning",size:"small",effect:"plain"},{default:o(()=>[v(r(l.channelType==="telegram"?"TG":"Web"),1)]),_:2},1032,["type"])):(d(),g(n,{key:1,type:"primary",size:"small",effect:"plain"},{default:o(()=>[...e[15]||(e[15]=[v("面板",-1)])]),_:1}))]),_:1}),s(_,{label:"标题 / 渠道","min-width":"240"},{default:o(({row:l})=>[i("div",qe,[i("span",Ge,r(l.title||l.channelId||"（无标题）"),1),i("span",Je,r(l.id),1)])]),_:1}),s(_,{label:"成员",width:"110"},{default:o(({row:l})=>[i("div",Oe,[i("span",{class:"agent-dot",style:Z({background:me.value[l.agentId]||"#6366f1"})},null,4),v(" "+r(l.agentName),1)])]),_:1}),s(_,{label:"消息",width:"70",align:"center"},{default:o(({row:l})=>[i("span",Xe,r(l.messageCount),1)]),_:1}),s(_,{label:"Token",width:"100",align:"center"},{default:o(({row:l})=>[l.source==="session"&&l.tokenEstimate?(d(),g(n,{key:0,type:l.tokenEstimate>6e4?"danger":l.tokenEstimate>3e4?"warning":"info",size:"small",effect:"plain"},{default:o(()=>[v(r(ne(l.tokenEstimate)),1)]),_:2},1032,["type"])):(d(),c("span",Qe,"—"))]),_:1}),s(_,{label:"最后活跃",width:"130"},{default:o(({row:l})=>[i("span",Ye,r(we(l.lastAt)),1)]),_:1}),s(_,{label:"创建时间",width:"120"},{default:o(({row:l})=>[i("span",Ze,r(U(l.firstAt||l.createdAt)),1)]),_:1}),s(_,{label:"操作",width:"160",onClick:e[6]||(e[6]=K(()=>{},["stop"]))},{default:o(({row:l})=>[s(a,{size:"small",link:"",onClick:K(x=>te(l),["stop"])},{default:o(()=>[...e[16]||(e[16]=[v("查看",-1)])]),_:1},8,["onClick"]),l.source==="session"?(d(),c(z,{key:0},[s(a,{size:"small",link:"",type:"primary",onClick:K(x=>ae(l),["stop"])},{default:o(()=>[...e[17]||(e[17]=[v("继续",-1)])]),_:1},8,["onClick"]),s(be,{title:"确认删除此对话？",onConfirm:x=>he(l),width:"180"},{reference:o(()=>[s(a,{size:"small",link:"",type:"danger",onClick:e[5]||(e[5]=K(()=>{},["stop"]))},{default:o(()=>[...e[18]||(e[18]=[v("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])],64)):P("",!0)]),_:1})]),_:1},8,["data"])),[[Ae,$.value]])]),_:1}),s(de,{modelValue:q.value,"onUpdate:modelValue":e[7]||(e[7]=l=>q.value=l),size:"50%",direction:"rtl"},{header:o(()=>[i("div",null,[i("div",et,r(y.value?.channelType==="telegram"?"Telegram":"Web")+" · "+r(y.value?.channelId),1),i("div",tt,r(y.value?.agentName)+" · "+r(y.value?.messageCount)+" 条消息 ",1)])]),footer:o(()=>[O.value>j?(d(),g(Ie,{key:0,"current-page":X.value,"page-size":j,total:O.value,layout:"prev, pager, next",onCurrentChange:ge,small:""},null,8,["current-page","total"])):P("",!0)]),default:o(()=>[J.value?(d(),c("div",lt,[s(Y,{class:"is-loading",size:"32"},{default:o(()=>[s(h(ce))]),_:1})])):(d(),c("div",at,[(d(!0),c(z,null,F(G.value,(l,x)=>(d(),c("div",{key:x,class:fe(["message-item",`msg-${l.role}`])},[i("div",st,[s(ie,{size:30,style:Z({background:l.role==="user"?"#409eff":"#67c23a"})},{default:o(()=>[v(r(l.role==="user"?"用":"AI"),1)]),_:2},1032,["style"])]),i("div",nt,[i("div",ot,[i("span",it,r(l.role==="user"?l.sender||"用户":"AI"),1),i("span",dt,r(U(new Date(l.ts).getTime())),1)]),i("div",{class:"msg-text",innerHTML:oe(l.content)},null,8,ut)])],2))),128)),G.value.length?P("",!0):(d(),g(Q,{key:0,description:"暂无消息"}))]))]),_:1},8,["modelValue"]),s(de,{modelValue:A.value,"onUpdate:modelValue":e[12]||(e[12]=l=>A.value=l),size:"50%",direction:"rtl"},{header:o(()=>[i("div",rt,[V.value?(d(),c("div",pt,[s(W,{modelValue:w.value,"onUpdate:modelValue":e[8]||(e[8]=l=>w.value=l),size:"small",style:{flex:"1"},onKeyup:Ue(se,["enter"])},null,8,["modelValue"]),s(a,{type:"primary",size:"small",onClick:se},{default:o(()=>[...e[19]||(e[19]=[v("保存",-1)])]),_:1}),s(a,{size:"small",onClick:e[9]||(e[9]=l=>V.value=!1)},{default:o(()=>[...e[20]||(e[20]=[v("取消",-1)])]),_:1})])):(d(),c("div",ct,[i("span",ft,r(p.value?.title||"（无标题）"),1),s(a,{icon:h(Re),circle:"",size:"small",onClick:ke},null,8,["icon"])])),i("div",mt,r(p.value?.agentName)+" · "+r(p.value?.messageCount??0)+" 条 · "+r(ne(p.value?.tokenEstimate??0))+" tokens ",1)])]),footer:o(()=>[i("div",At,[s(a,{onClick:e[10]||(e[10]=l=>A.value=!1)},{default:o(()=>[...e[23]||(e[23]=[v("关闭",-1)])]),_:1}),s(a,{type:"primary",icon:h(Se),onClick:e[11]||(e[11]=l=>ae(p.value)),disabled:!p.value},{default:o(()=>[...e[24]||(e[24]=[v(" 继续对话 ",-1)])]),_:1},8,["icon","disabled"])])]),default:o(()=>[R.value?(d(),c("div",vt,[s(Y,{class:"is-loading",size:"32"},{default:o(()=>[s(h(ce))]),_:1})])):(d(),c("div",_t,[(d(!0),c(z,null,F(S.value,(l,x)=>(d(),c("div",{key:x,class:fe(["message-item",`msg-${l.role}`])},[l.isCompact?(d(),c("div",gt,[s(Te,null,{default:o(()=>[s(Y,null,{default:o(()=>[s(h(Me))]),_:1}),e[21]||(e[21]=i("span",{style:{"margin-left":"6px","font-size":"12px",color:"#909399"}},"以上内容已压缩",-1))]),_:1}),i("div",yt,r(l.text),1)])):(d(),c(z,{key:1},[i("div",ht,[s(ie,{size:30,style:Z({background:l.role==="user"?"#409eff":"#67c23a"})},{default:o(()=>[v(r(l.role==="user"?"用":"AI"),1)]),_:2},1032,["style"])]),i("div",kt,[i("div",Ct,[i("span",wt,r(l.role==="user"?"用户":"AI"),1),i("span",bt,r(U(l.timestamp)),1)]),l.toolCalls?.length?(d(),c("div",xt,[(d(!0),c(z,null,F(l.toolCalls,B=>(d(),c("div",{key:B.id,class:"hist-tool-step"},[e[22]||(e[22]=i("span",{class:"hist-tool-dot"},"✓",-1)),i("span",zt,r(B.name),1),i("span",It,r(Ce(B.name,B.input||"")),1)]))),128))])):(d(),c("div",{key:1,class:"msg-text",innerHTML:oe(l.text||"")},null,8,Tt))])],64))],2))),128)),!S.value.length&&!R.value?(d(),g(Q,{key:0,description:"暂无消息记录"})):P("",!0)]))]),_:1},8,["modelValue"])])}}}),Lt=He(Vt,[["__scopeId","data-v-10161102"]]);export{Lt as default};
