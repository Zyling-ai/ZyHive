import{d as X,o as Y,ap as P,aq as $,ar as ee,c as _,e as s,b as e,w as t,f as u,r as d,h as c,i as p,n as v,as as ae,t as g,g as m,at as q,au as te,U as le,av as se,aw as oe,a1 as ne,l as ie,ax as ue,ay as re,E as C,az as E,I as A,B as de}from"./index-DU4MpSwp.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"settings-page"},ve={style:{margin:"0 0 20px"}},fe={class:"version-section"},_e={class:"version-row"},ge={class:"version-info"},me={class:"version-value"},ye={key:0,class:"version-info"},he={class:"version-value"},we={key:0,class:"check-tip ok"},ke={key:1,class:"check-tip new"},be=["href"],xe={key:2,class:"update-progress"},Ve={class:"progress-header"},Ue={class:"stage-label"},Be={class:"progress-pct"},Ce={class:"progress-msg"},ze={key:0,class:"restart-tip"},Se={key:1,class:"restart-tip waiting"},Ee={key:2,class:"fail-tip"},Ie={key:3,class:"rollback-tip"},De={class:"update-actions"},Ne={class:"data-safe-tip"},Re=X({__name:"SettingsView",setup(Te){const k=d(8080),b=d(""),I=d("zh"),D=d("light"),z=d(!1);Y(async()=>{try{const l=await P.get();k.value=l.data.gateway?.port||8080}catch{}L()});async function H(){z.value=!0;try{const l={gateway:{port:k.value}};b.value&&(l.auth={mode:"token",token:b.value}),await P.patch(l),C.success("设置已保存")}catch(l){C.error(l.response?.data?.error||"保存失败")}finally{z.value=!1}}const w=d(""),S=d(!1),o=d(null),n=d(null),r=d(!1),x=d(!1);let h=null;async function L(){try{const l=await $.get("/api/version");w.value=l.data.version}catch{}}async function W(){S.value=!0,o.value=null;try{const l=await E.check();o.value=l.data}catch(l){C.error(l.response?.data?.error||"检查更新失败，请检查网络")}finally{S.value=!1}}async function Z(){if(o.value?.hasUpdate){try{await de.confirm(`确认将 ZyHive 从 ${w.value} 升级到 ${o.value.latest}？

升级过程中服务将短暂重启（约 10-30 秒），成员数据和配置文件不受影响。`,"确认升级",{confirmButtonText:"立即升级",cancelButtonText:"取消",type:"warning"})}catch{return}r.value=!0,x.value=!1,n.value=null;try{await E.apply(o.value.latest)}catch(l){C.error(l.response?.data?.error||"启动升级失败"),r.value=!1;return}j()}}function j(){h&&clearInterval(h);let l=null;h=setInterval(async()=>{try{const a=await E.status();n.value=a.data;const i=a.data.stage;if(i==="done"){r.value=!1,l||(l=Date.now());try{const f=(await $.get("/api/version",{timeout:3e3})).data.version;f&&f!==w.value?(w.value=f,x.value=!0,V()):l&&Date.now()-l>6e4&&(x.value=!0,V())}catch{}}else(i==="failed"||i==="rolledback")&&(r.value=!1,V())}catch{}},1500)}function V(){h&&(clearInterval(h),h=null)}function F(){window.location.reload()}ee(()=>V());const G=A(()=>({idle:"空闲",downloading:"下载中",verifying:"验证中",applying:"替换文件",done:"升级完成",failed:"升级失败",rolledback:"已回滚"})[n.value?.stage??"idle"]??""),J=A(()=>{const l=n.value?.stage;if(l==="done")return"success";if(l==="failed")return"exception";if(l==="rolledback")return"warning"});return(l,a)=>{const i=c("el-icon"),N=c("el-input-number"),f=c("el-form-item"),K=c("el-input"),U=c("el-option"),R=c("el-select"),B=c("el-button"),O=c("el-form"),T=c("el-card"),M=c("el-tag"),Q=c("el-progress");return p(),_("div",pe,[s("h2",ve,[e(i,{style:{"vertical-align":"-2px","margin-right":"6px"}},{default:t(()=>[e(v(ae))]),_:1}),a[4]||(a[4]=u("系统设置",-1))]),e(T,{shadow:"hover",style:{"max-width":"600px","margin-bottom":"20px"}},{header:t(()=>[...a[5]||(a[5]=[s("span",{style:{"font-weight":"600"}},"基本设置",-1)])]),default:t(()=>[e(O,{"label-width":"120px"},{default:t(()=>[e(f,{label:"面板端口"},{default:t(()=>[e(N,{modelValue:k.value,"onUpdate:modelValue":a[0]||(a[0]=y=>k.value=y),min:1024,max:65535},null,8,["modelValue"])]),_:1}),e(f,{label:"访问令牌"},{default:t(()=>[e(K,{modelValue:b.value,"onUpdate:modelValue":a[1]||(a[1]=y=>b.value=y),type:"password","show-password":"",placeholder:"留空保持不变",style:{"max-width":"300px"}},null,8,["modelValue"])]),_:1}),e(f,{label:"语言"},{default:t(()=>[e(R,{modelValue:I.value,"onUpdate:modelValue":a[2]||(a[2]=y=>I.value=y),style:{width:"200px"}},{default:t(()=>[e(U,{label:"中文",value:"zh"}),e(U,{label:"English",value:"en",disabled:""})]),_:1},8,["modelValue"])]),_:1}),e(f,{label:"主题"},{default:t(()=>[e(R,{modelValue:D.value,"onUpdate:modelValue":a[3]||(a[3]=y=>D.value=y),style:{width:"200px"}},{default:t(()=>[e(U,{label:"浅色",value:"light"}),e(U,{label:"深色",value:"dark",disabled:""})]),_:1},8,["modelValue"])]),_:1}),e(f,null,{default:t(()=>[e(B,{type:"primary",onClick:H,loading:z.value},{default:t(()=>[...a[6]||(a[6]=[u("保存设置",-1)])]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),e(T,{shadow:"hover",style:{"max-width":"600px"}},{header:t(()=>[...a[7]||(a[7]=[s("span",{style:{"font-weight":"600"}},"版本与更新",-1)])]),default:t(()=>[s("div",fe,[s("div",_e,[s("div",ge,[a[8]||(a[8]=s("div",{class:"version-label"},"当前版本",-1)),s("div",me,[e(M,{type:"info",size:"small"},{default:t(()=>[u(g(w.value||"…"),1)]),_:1})])]),o.value?(p(),_("div",ye,[a[9]||(a[9]=s("div",{class:"version-label"},"最新版本",-1)),s("div",he,[e(M,{type:o.value.hasUpdate?"success":"info",size:"small"},{default:t(()=>[u(g(o.value.latest),1)]),_:1},8,["type"])])])):m("",!0)]),o.value&&!o.value.hasUpdate&&!r.value?(p(),_("div",we,[e(i,null,{default:t(()=>[e(v(q))]),_:1}),a[10]||(a[10]=u(" 当前已是最新版本，无需升级 ",-1))])):m("",!0),o.value&&o.value.hasUpdate&&!r.value?(p(),_("div",ke,[e(i,null,{default:t(()=>[e(v(te))]),_:1}),u(" 发现新版本 "+g(o.value.latest)+"，可立即升级 ",1),s("a",{href:o.value.releaseUrl,target:"_blank",style:{"margin-left":"8px","font-size":"12px"}},"查看更新日志 →",8,be)])):m("",!0),r.value||n.value?(p(),_("div",xe,[s("div",Ve,[s("span",Ue,g(G.value),1),s("span",Be,g(n.value?.progress??0)+"%",1)]),e(Q,{percentage:n.value?.progress??0,status:J.value,striped:r.value,"striped-flow":r.value,duration:10},null,8,["percentage","status","striped","striped-flow"]),s("div",Ce,g(n.value?.message),1),n.value?.stage==="done"&&x.value?(p(),_("div",ze,[e(i,null,{default:t(()=>[e(v(q))]),_:1}),u(" 服务已重启，新版本 "+g(n.value.newVersion)+" 运行中 ",1),e(B,{type:"primary",size:"small",style:{"margin-left":"12px"},onClick:F},{default:t(()=>[...a[11]||(a[11]=[u("刷新页面",-1)])]),_:1})])):n.value?.stage==="done"?(p(),_("div",Se,[e(i,{class:"spin"},{default:t(()=>[e(v(le))]),_:1}),a[12]||(a[12]=u(" 等待服务重启… ",-1))])):m("",!0),n.value?.stage==="failed"?(p(),_("div",Ee,[e(i,null,{default:t(()=>[e(v(se))]),_:1}),u(" "+g(n.value.message),1)])):m("",!0),n.value?.stage==="rolledback"?(p(),_("div",Ie,[e(i,null,{default:t(()=>[e(v(oe))]),_:1}),a[13]||(a[13]=u(" 升级失败，已自动回滚到旧版本 ",-1))])):m("",!0)])):m("",!0),s("div",De,[e(B,{loading:S.value,disabled:r.value,onClick:W},{default:t(()=>[e(i,{style:{"margin-right":"4px"}},{default:t(()=>[e(v(ne))]),_:1}),a[14]||(a[14]=u(" 检查更新 ",-1))]),_:1},8,["loading","disabled"]),o.value?.hasUpdate?(p(),ie(B,{key:0,type:"primary",loading:r.value,disabled:r.value,onClick:Z},{default:t(()=>[e(i,{style:{"margin-right":"4px"}},{default:t(()=>[e(v(ue))]),_:1}),u(" 升级到 "+g(o.value.latest),1)]),_:1},8,["loading","disabled"])):m("",!0)]),s("div",Ne,[e(i,null,{default:t(()=>[e(v(re))]),_:1}),a[15]||(a[15]=u(" 升级仅替换程序文件，成员数据、对话记录、配置文件全部保留 ",-1))])])]),_:1})])}}}),$e=ce(Re,[["__scopeId","data-v-14831c95"]]);export{$e as default};
