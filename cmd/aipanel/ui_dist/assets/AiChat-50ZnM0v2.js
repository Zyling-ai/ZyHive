import{d as Te,c as o,F as R,b as D,w as F,ah as oe,i as a,e as n,t as v,ai as tt,p as E,n as le,f as q,g as p,y as A,j as O,r as $,I as Q,P as st,T as Se,o as nt,l as fe,q as at,Q as ot,k as Ie,S as Y,aj as lt,X as ae,ak as it,al as rt,h as G,ae as ve,x as ut}from"./index-CWvJj5CN.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ct={key:0,class:"dispatch-panel"},dt={class:"dp-header"},pt={class:"dp-count"},ft={key:0,class:"dp-body"},vt={key:0,class:"dp-done-badge"},gt={key:1,class:"dp-error-badge"},ht={class:"dp-info"},mt={class:"dp-name-row"},_t={class:"dp-name"},kt={key:0,class:"dp-progress-wrap"},yt={key:0,class:"dp-progress-num"},bt=["onClick"],wt={class:"dp-dialog"},xt={class:"dp-dialog-header"},Ct={class:"dp-dialog-body"},$t={class:"dp-tl-content"},St={class:"dp-tl-text"},It={class:"dp-tl-meta"},Tt={class:"dp-tl-time"},Dt={key:0,class:"dp-tl-progress"},Mt={key:0,class:"dp-dialog-empty"},Nt=Te({__name:"DispatchPanel",props:{sessionId:{}},setup(P,{expose:ie}){const S=$(new Map),C=$(!1),U=$(!1),k=$(""),L=$([]),B=Q(()=>S.value.size>0),J=Q(()=>[...S.value.values()].filter(y=>y.status!=="done"&&y.status!=="error")),w=Q(()=>[...S.value.values()].sort((y,h)=>y.spawnedAt-h.spawnedAt));function T(y){const h=typeof y=="string"?JSON.parse(y):y;if(!h)return;const g=h.subagentSessionId;if(g){if(h.type==="subagent_spawn"||h.type==="spawn"){const b={subagentSessionId:g,agentId:h.agentId||"",agentName:h.agentName||h.agentId||"æœªçŸ¥æˆå‘˜",avatarColor:h.avatarColor||"#6366f1",status:"running",progress:0,reports:[],latestReport:"",reportNew:!1,spawnedAt:h.timestamp||Date.now()};S.value=new Map(S.value.set(g,b))}else if(h.type==="subagent_report"||h.type==="report"){const b=S.value.get(g);if(b){const V={content:h.content||"",status:h.status||"running",progress:h.progress||0,timestamp:h.timestamp||Date.now()};b.reports.push(V),b.latestReport=h.content||"",h.progress&&(b.progress=h.progress),h.status==="done"?b.status="done":h.status==="blocked"?b.status="blocked":b.status="running",b.reportNew=!0,setTimeout(()=>{b&&(b.reportNew=!1)},900),S.value=new Map(S.value)}}else if(h.type==="subagent_done"||h.type==="done"){const b=S.value.get(g);b&&(b.status="done",b.doneAt=h.timestamp||Date.now(),S.value=new Map(S.value),setTimeout(()=>{S.value.delete(g),S.value=new Map(S.value)},3e3))}else if(h.type==="subagent_error"||h.type==="error"){const b=S.value.get(g);b&&(b.status="error",S.value=new Map(S.value))}}}ie({handleEvent:T});function j(y){return{running:"æ‰§è¡Œä¸­",blocked:"é‡åˆ°é˜»ç¢",done:"å·²å®Œæˆ",error:"å‡ºé”™"}[y]??y}function M(y,h){return y.length>h?y.slice(0,h)+"â€¦":y}function K(y){return new Date(y).toLocaleTimeString("zh-CN")}function z(y){k.value=y.agentName,L.value=[...y.reports].reverse(),U.value=!0}return(y,h)=>(a(),o(R,null,[D(oe,{name:"panel-slide"},{default:F(()=>[B.value?(a(),o("div",ct,[n("div",dt,[h[3]||(h[3]=n("span",{class:"dp-pulse"},null,-1)),h[4]||(h[4]=n("span",{class:"dp-title"},"æ´¾é£ä»»åŠ¡è¿›è¡Œä¸­",-1)),n("span",pt,v(J.value.length)+" åæˆå‘˜æ‰§è¡Œä¸­",1),n("button",{class:"dp-collapse-btn",onClick:h[0]||(h[0]=g=>C.value=!C.value)},v(C.value?"å±•å¼€ âˆ¨":"æ”¶èµ· âˆ§"),1)]),D(oe,{name:"dp-expand"},{default:F(()=>[C.value?p("",!0):(a(),o("div",ft,[D(tt,{name:"member-fly",tag:"div",class:"dp-members"},{default:F(()=>[(a(!0),o(R,null,E(w.value,(g,b)=>(a(),o("div",{key:g.subagentSessionId,class:"dp-member",style:le({transitionDelay:b*80+"ms"})},[n("div",{class:A(["dp-avatar","status-"+g.status]),style:le({background:g.avatarColor||"#6366f1"})},[q(v((g.agentName||"?")[0])+" ",1),g.status==="done"?(a(),o("span",vt,"âœ“")):p("",!0),g.status==="error"?(a(),o("span",gt,"!")):p("",!0)],6),n("div",ht,[n("div",mt,[n("span",_t,v(g.agentName),1),n("span",{class:A(["dp-tag","tag-"+g.status])},v(j(g.status)),3),g.progress>0||g.status==="running"?(a(),o("div",kt,[n("div",{class:"dp-progress-bar",style:le({width:g.progress+"%"})},null,4),g.progress>0?(a(),o("span",yt,v(g.progress)+"%",1)):p("",!0)])):p("",!0)]),g.latestReport?(a(),o("div",{key:0,class:A(["dp-report",{"dp-report-new":g.reportNew}])},[q(' "'+v(M(g.latestReport,60))+'" ',1),g.reports.length>1?(a(),o("button",{key:0,class:"dp-view-all",onClick:V=>z(g)}," å…¨éƒ¨ ("+v(g.reports.length)+") ",9,bt)):p("",!0)],2)):p("",!0)])],4))),128))]),_:1})]))]),_:1})])):p("",!0)]),_:1}),D(oe,{name:"dialog-fade"},{default:F(()=>[U.value?(a(),o("div",{key:0,class:"dp-dialog-mask",onClick:h[2]||(h[2]=O(g=>U.value=!1,["self"]))},[n("div",wt,[n("div",xt,[n("span",null,v(k.value)+" çš„æ±‡æŠ¥è®°å½•",1),n("button",{class:"dp-dialog-close",onClick:h[1]||(h[1]=g=>U.value=!1)},"Ã—")]),n("div",Ct,[(a(!0),o(R,null,E(L.value,g=>(a(),o("div",{key:g.timestamp,class:"dp-timeline-item"},[n("div",{class:A(["dp-tl-dot","tl-"+g.status])},null,2),n("div",$t,[n("div",St,v(g.content),1),n("div",It,[n("span",Tt,v(K(g.timestamp)),1),g.progress>0?(a(),o("span",Dt,v(g.progress)+"%",1)):p("",!0),n("span",{class:A(["dp-tl-status dp-tag","tag-"+g.status])},v(j(g.status)),3)])])]))),128)),L.value.length?p("",!0):(a(),o("div",Mt,"æš‚æ— æ±‡æŠ¥è®°å½•"))])])])):p("",!0)]),_:1})],64))}}),Rt=De(Nt,[["__scopeId","data-v-ab912bc9"]]),jt={key:0,class:"drag-overlay"},At={key:1,class:"running-tasks-banner"},Ot={key:0,class:"resumed-list"},Et={key:0,class:"history-loading"},Ft={key:1,class:"chat-empty"},Pt={key:0,class:"welcome-msg"},Ut={key:1,class:"examples"},Lt=["onClick"],Bt={key:0,class:"msg-row user"},Jt={class:"msg-bubble user"},zt={key:0,class:"msg-images"},qt=["src","onClick"],Ht={class:"msg-text"},Kt={key:1,class:"msg-row assistant"},Vt={class:"msg-col"},Gt=["open"],Wt={class:"thinking-summary"},Xt={class:"thinking-len"},Yt={class:"thinking-content"},Qt={key:1,class:"tool-timeline"},Zt=["onClick"],es={class:"tool-step-header"},ts={key:0,class:"tool-spin"},ss={key:1},ns={key:2},as={key:3},os={class:"tool-step-icon"},ls={class:"tool-step-name"},is={key:0,class:"tool-step-summary"},rs={key:1,class:"tool-step-dur"},us={key:0},cs={key:1},ds={key:2},ps={key:3},fs={key:4},vs={class:"tool-step-chevron"},gs={key:0,class:"tool-section"},hs={class:"tool-pre"},ms={key:1,class:"tool-section"},_s={class:"tool-pre result"},ks=["src","onClick"],ys=["href"],bs={class:"tool-file-name"},ws={class:"tool-file-size"},xs={class:"msg-bubble assistant"},Cs={key:0,class:"no-model-card"},$s={class:"no-model-body"},Ss=["innerHTML"],Is={key:2,class:"apply-card"},Ts={class:"apply-preview"},Ds={class:"apply-key"},Ms={class:"apply-val"},Ns=["onClick"],Rs={class:"msg-actions"},js=["onClick","title"],As=["onClick"],Os=["onClick"],Es={key:2,class:"option-chips"},Fs=["onClick"],Ps={key:2,class:"msg-row system"},Us={class:"msg-system"},Ls={key:2,class:"msg-row assistant"},Bs={class:"msg-col"},Js={key:0,class:"thinking-block",open:""},zs={class:"thinking-summary"},qs={class:"thinking-content"},Hs={key:1,class:"tool-timeline"},Ks=["onClick"],Vs={class:"tool-step-header"},Gs={key:0,class:"tool-spin"},Ws={key:1},Xs={key:2},Ys={class:"tool-step-icon"},Qs={class:"tool-step-name"},Zs={key:0,class:"tool-step-summary"},en={key:1,class:"tool-step-dur"},tn={key:0},sn={key:1},nn={key:2},an={key:3},on={key:4},ln={class:"tool-step-chevron"},rn={key:0,class:"tool-section"},un={class:"tool-pre"},cn={key:1,class:"tool-section"},dn={class:"tool-pre result"},pn=["src","onClick"],fn=["href"],vn={class:"tool-file-name"},gn={class:"tool-file-size"},hn={key:2,class:"msg-bubble assistant"},mn={key:0,class:"typing-dots"},_n=["innerHTML"],kn={key:2,class:"blink"},yn=["src"],bn={class:"chat-input-area"},wn={key:0,class:"attachments-bar"},xn=["src"],Cn=["onClick"],$n={class:"attach-file-icon"},Sn={class:"attach-file-name"},In={class:"attach-file-size"},Tn=["onClick"],Dn={class:"input-row"},Mn={class:"textarea-wrap"},Nn=["placeholder","disabled","onKeydown"],Rn={class:"input-actions"},jn={class:"icon-btn",title:"é™„åŠ æ–‡ä»¶ï¼ˆå›¾ç‰‡/ä»£ç /æ–‡æœ¬ï¼‰"},An=["disabled"],On={key:0,class:"spinner"},En={key:1},Fn=Te({__name:"AiChat",props:{agentId:{},sessionId:{},context:{},scenario:{},skillId:{},placeholder:{},welcomeMessage:{},examples:{default:()=>[]},showThinking:{type:Boolean,default:!1},compact:{type:Boolean,default:!1},bgColor:{},height:{},initialMessages:{},applyable:{type:Boolean,default:!1}},emits:["message","response","apply","session-change","streaming-change"],setup(P,{expose:ie,emit:S}){const C=P,U=S,k=$(C.initialMessages?[...C.initialMessages]:[]),L=$(""),B=$([]),J=$([]),w=$(!1);st(w,s=>U("streaming-change",s));const T=$(""),j=$(""),M=$([]),K=ut(new Map),z=$([]);let y=null;const h=Q(()=>{let s=0;for(const e of k.value)for(const l of e.toolCalls??[])l.taskId&&l.taskStatus&&!["done","error","killed"].includes(l.taskStatus)&&s++;return s+=z.value.filter(e=>!["done","error","killed"].includes(e.status)).length,s}),g=$(!1);let b=0;const V=$(null),Z=$(""),x=$(C.sessionId),W=$(!1),ee=$(),H=$(),re=$(null),Me=Q(()=>({height:C.height??"100%","--bg":C.bgColor??"transparent"}));function ge(){y||(y=setInterval(Ne,3e3))}async function Ne(){if(K.size===0&&z.value.every(u=>["done","error","killed"].includes(u.status))){y&&(clearInterval(y),y=null);return}const e=[];let l=!1;for(const[u,r]of K)try{const c=(await ve.get(r)).data;for(const t of k.value){const m=t.toolCalls?.find(i=>i.id===u);if(m){const i=!["done","error","killed"].includes(m.taskStatus??"");m.taskStatus=c.status,["done","error","killed"].includes(c.status)&&(e.push(u),i&&(l=!0))}}}catch{e.push(u),l=!0}for(const u of e)K.delete(u);let d=!1;for(const u of z.value)if(!["done","error","killed"].includes(u.status))try{const r=await ve.get(u.id),f=u.status;u.status=r.data.status,["done","error","killed"].includes(u.status)&&f!==u.status&&(d=!0)}catch{u.status="error",d=!0}if(!(K.size>0||z.value.some(u=>!["done","error","killed"].includes(u.status)))&&y&&(clearInterval(y),y=null),(d||l)&&x.value&&!w.value){const u=x.value;setTimeout(async()=>{if(!w.value&&x.value===u)try{const r=await ae.get(C.agentId,u);if(w.value||x.value!==u)return;const f=r.data.messages??[],c=[];f.some(t=>t.isCompact||t.role==="compaction")&&c.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const t of f)t.role!=="compaction"&&c.push({role:t.role,text:t.text,toolCalls:t.toolCalls?.map(m=>({id:m.id,name:m.name,input:m.input,result:m.result,status:"done",_expanded:!1,...X(m.result??"")}))});k.value=c,I()}catch{}},1500)}}Se(()=>{y&&(clearInterval(y),y=null)});async function Re(s){try{const l=(await ve.list({sessionId:s})).data,d=l.filter(u=>!["done","error","killed"].includes(u.status));if(l.filter(u=>["done","error","killed"].includes(u.status)).length>0&&setTimeout(async()=>{if(!w.value&&x.value===s)try{const u=await ae.get(C.agentId,s);if(w.value||x.value!==s)return;const r=u.data.messages??[],f=[];r.some(c=>c.isCompact||c.role==="compaction")&&f.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const c of r)c.role!=="compaction"&&f.push({role:c.role,text:c.text,toolCalls:c.toolCalls?.map(t=>({id:t.id,name:t.name,input:t.input,result:t.result,status:"done",_expanded:!1,...X(t.result??"")}))});k.value=f,I()}catch{}},500),d.length===0)return;z.value=d.map(u=>({id:u.id,label:u.label||u.id.slice(0,8),status:u.status})),ge()}catch{}}function I(){Y(()=>{ee.value&&(ee.value.scrollTop=ee.value.scrollHeight)})}function je(){H.value&&(H.value.style.height="auto",H.value.style.height=Math.min(H.value.scrollHeight,160)+"px")}function te(s){L.value=s,Y(()=>H.value?.focus())}function he(s){try{return JSON.stringify(JSON.parse(s),null,2)}catch{return s}}function Ae(s){navigator.clipboard?.writeText(s);const e=k.value.findIndex(l=>l.text===s);V.value=e,setTimeout(()=>{V.value=null},1500)}function Oe(s){for(let e=s-1;e>=0;e--){const l=k.value[e];if(l&&l.role==="user"){const d=l.text,_=l.images??[];k.value.splice(e,k.value.length-e),de(d,_);return}}}function ue(s){Z.value=s}function X(s){const e={};if(!s)return e;const l=s.match(/\[media:([^\]]+)\]/);if(l&&l[1]){const _=localStorage.getItem("aipanel_token")??"";e.mediaUrl=`/api/media?path=${encodeURIComponent(l[1])}&token=${encodeURIComponent(_)}`}const d=s.match(/\[file_card:([^|]+)\|([^|]+)\|([^\]]+)\]/);return d&&d[1]&&d[2]&&d[3]&&(e.fileCard={url:d[1],name:d[2],size:d[3]}),e}function me(s){return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/```(\w*)\n([\s\S]*?)```/g,(l,d,_)=>`<pre class="code-block${d?" lang-"+d:""}"><code>${_}</code></pre>`).replace(/`([^`]+)`/g,'<code class="inline-code">$1</code>').replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/\[(.+?)\]\((https?:\/\/[^\)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>').replace(/^### (.+)$/gm,"<h3>$1</h3>").replace(/^## (.+)$/gm,"<h2>$1</h2>").replace(/^# (.+)$/gm,"<h1>$1</h1>").replace(/^[-*] (.+)$/gm,"<li>$1</li>").replace(/^\d+\. (.+)$/gm,"<li>$1</li>").replace(/(<li>[\s\S]+?<\/li>)(\n(?!<li>)|$)/g,"<ul>$1</ul>$2").replace(/([^>])\n([^<])/g,"$1<br>$2"):""}function Ee(s){const e=s.split(`
`),l=[],d=/^([ğŸ™ğŸ˜„ğŸŒğŸ›ğŸ“šğŸ¨ğŸ’¼ğŸ¤–âš½ğŸ¯âœ…âŒğŸ”¥ğŸ’¡ğŸğŸš€ğŸŒŸğŸ’ğŸªğŸ­ğŸ¬ğŸ¤]|[\u{1F300}-\u{1FFFF}]|[\u{2600}-\u{27BF}])\s+(.{4,40})/u;for(const _ of e){const u=_.replace(/^[-*â€¢]\s*/,"").trim();if(u.match(d)){const f=u.replace(/[ï¼š:ã€‚ï¼Œ,]$/,"").trim();f.length>=5&&l.push(f)}}return l.slice(0,5)}function Fe(s){return s?/\{[\s\S]{30,}\}/.test(s)&&(s.includes('"name"')||s.includes('"identity"')||s.includes('"soul"')||s.includes('"IDENTITY"')||s.includes('"SOUL"')):!1}function Pe(s){const e=ke(s.text);e?(k.value.forEach(l=>{l!==s&&l.applyData&&delete l.applyData}),s.applyData=e,Y(()=>U("apply",e))):alert("æœªèƒ½ä»æ¶ˆæ¯ä¸­æå–åˆ°é…ç½® JSONï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶")}function _e(s,e=0){const l=s.indexOf("{",e);if(l===-1)return null;let d=0,_=!1,u=!1;for(let r=l;r<s.length;r++){const f=s[r];if(u){u=!1;continue}if(f==="\\"&&_){u=!0;continue}if(f==='"'){_=!_;continue}if(!_){if(f==="{")d++;else if(f==="}"&&(d--,d===0))return{raw:s.slice(l,r+1),end:r+1}}}return null}function ke(s){const e=/```(?:json)?\s*\n?([\s\S]*?)```/g,l=[];let d;for(;(d=e.exec(s))!==null;){const r=(d[1]??"").trim();r.startsWith("{")&&l.push(r)}for(let r=l.length-1;r>=0;r--){const f=l[r],c=_e(f);if(!c)continue;const t=se(c.raw)??se(ye(c.raw));if(t)return t}const _=[];let u=0;for(;u<s.length;){const r=_e(s,u);if(!r)break;_.push(r.raw),u=r.end}for(let r=_.length-1;r>=0;r--){const f=_[r],c=se(f)??se(ye(f));if(c)return c}return null}function se(s){try{const e=JSON.parse(s);if(e&&typeof e=="object"&&!Array.isArray(e)){const l=["name","id","description","identity","soul","IDENTITY","SOUL","NAME","DESCRIPTION"];if(Object.keys(e).some(d=>l.includes(d)))return e}}catch{}return null}function ye(s){let e="",l=!1,d=!1;for(let _=0;_<s.length;_++){const u=s[_];if(d){e+=u,d=!1;continue}if(u==="\\"&&l){e+=u,d=!0;continue}if(u==='"'){l=!l,e+=u;continue}if(l&&u===`
`){e+="\\n";continue}if(l&&u==="\r"){e+="\\r";continue}e+=u}return e}const Ue={exec:"âš¡",bash:"âš¡",read:"ğŸ“–",write:"âœï¸",edit:"âœï¸",web_search:"ğŸŒ",web_fetch:"ğŸŒ",browser:"ğŸŒ",agent_spawn:"ğŸš€",agent_tasks:"ğŸ“‹",agent_kill:"ğŸ›‘",agent_result:"ğŸ“Š",project_read:"ğŸ“",project_write:"ğŸ“",project_list:"ğŸ“",project_create:"ğŸ“",project_glob:"ğŸ“",memory_search:"ğŸ§ ",memory_get:"ğŸ§ ",image:"ğŸ–¼ï¸",tts:"ğŸ”Š",show_image:"ğŸ–¼ï¸",cron:"â±ï¸"};function be(s){return Ue[s]??"âš™ï¸"}function we(s,e){try{const l=JSON.parse(e);if(s==="exec"||s==="bash")return(l.command??"").slice(0,60);if(s==="read")return l.file_path??l.path??"";if(s==="write")return(l.file_path??l.path??"")+(l.content?` (${l.content.length}B)`:"");if(s==="edit")return l.file_path??l.path??"";if(s==="web_search")return l.query??"";if(s==="web_fetch")return l.url??"";if(s==="agent_spawn")return`â†’ ${l.agentId}: ${(l.task??"").slice(0,40)}`;if(s==="project_read"||s==="project_write")return l.path??"";if(s==="memory_search")return l.query??"";if(s==="show_image")return(l.path??"").split("/").pop()??""}catch{}return""}const Le=new Set(["txt","md","markdown","js","ts","jsx","tsx","vue","go","py","rs","java","kt","swift","html","css","scss","less","json","yaml","yml","toml","ini","cfg","env","sh","bash","zsh","fish","ps1","bat","cmd","dockerfile","makefile","sql","graphql","proto","xml","svg","gitignore","gitattributes"]);function xe(s){const e=s.split(".").pop()?.toLowerCase()??"";return Le.has(e)}function Be(s){const e=s.split(".").pop()?.toLowerCase()??"";return{js:"ğŸŸ¨",ts:"ğŸ”µ",vue:"ğŸ’š",go:"ğŸ¹",py:"ğŸ",rs:"ğŸ¦€",html:"ğŸŒ",css:"ğŸ¨",json:"ğŸ“‹",md:"ğŸ“",sh:"âš¡",sql:"ğŸ—„ï¸",yaml:"âš™ï¸",yml:"âš™ï¸",dockerfile:"ğŸ³"}[e]??"ğŸ“„"}function Je(s){return s<1024?`${s}B`:s<1024*1024?`${(s/1024).toFixed(1)}KB`:`${(s/1024/1024).toFixed(1)}MB`}function ze(s){const e=s.clipboardData?.items;if(e){for(const l of Array.from(e))if(l.type.startsWith("image/")){s.preventDefault();const d=l.getAsFile();d&&ce(d)}}}function qe(s){s.preventDefault(),b++,g.value=!0}function He(s){s.preventDefault(),b--,b<=0&&(b=0,g.value=!1)}function Ke(s){b=0,g.value=!1;const e=s.dataTransfer?.files;if(e)for(const l of Array.from(e))l.type.startsWith("image/")?ce(l):xe(l.name)&&Ce(l)}function Ve(s){const e=s.target.files;if(e){for(const l of Array.from(e))l.type.startsWith("image/")?ce(l):xe(l.name)&&Ce(l);s.target.value=""}}function Ce(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&J.value.push({name:s.name,content:e.result})},e.readAsText(s)}function ce(s){const e=new FileReader;e.onload=()=>{typeof e.result=="string"&&B.value.push(e.result)},e.readAsDataURL(s)}function Ge(s){B.value.splice(s,1)}function ne(){const s=L.value.trim(),e=[...B.value],l=[...J.value];if(!s&&!e.length&&!l.length||w.value)return;let d=s;if(l.length>0){const _=l.map(u=>{const r=u.name.split(".").pop()??"text";return`

ğŸ“ **${u.name}**
\`\`\`${r}
${u.content}
\`\`\``}).join("");d=s?s+_:_.trimStart()}L.value="",B.value=[],J.value=[],Y(()=>{H.value&&(H.value.style.height="auto")}),U("message",d,e),de(d,e)}function de(s,e,l=!1){l||(k.value.push({role:"user",text:s,images:e.length?e:void 0}),I()),w.value=!0,T.value="",j.value="",M.value=[];const d={role:"assistant",text:"",toolCalls:[]};k.value.push(d),l&&I();const _=k.value.length-1;let u="",r;if(x.value)r=void 0;else{const c=k.value.slice(0,-1).filter(t=>(t.role==="user"||t.role==="assistant")&&t.text).slice(-20).map(t=>({role:t.role,content:t.text}));r=c.length>0?c:void 0}const f={sessionId:x.value,context:C.context,scenario:C.scenario,skillId:C.skillId,images:e.length?e:void 0,history:r};lt(C.agentId,s,c=>{switch(c.type){case"thinking_delta":j.value+=c.text,I();break;case"text":case"text_delta":T.value+=c.text,I();break;case"tool_call":{const t={id:c.tool_call?.id??String(Date.now()),name:c.tool_call?.name??"tool",input:c.tool_call?.input?JSON.stringify(c.tool_call.input):void 0,status:"running",_startedAt:Date.now(),_expanded:!1};k.value[_].toolCalls.push(t),M.value.push(t),u=t.id,I();break}case"tool_result":{const t=k.value[_].toolCalls?.find(m=>m.id===u);if(t){if(t.result=c.text,t.status="done",t._startedAt){const i=Date.now()-t._startedAt;t.duration=i<1e3?`${i}ms`:`${(i/1e3).toFixed(1)}s`}if(c.text&&Object.assign(t,X(c.text)),t.name==="agent_spawn"&&c.text){const i=c.text.match(/ä»»åŠ¡\s*ID[ï¼š:]\s*([a-f0-9-]{8,})/i);i&&(t.taskId=i[1],t.taskStatus="pending",K.set(u,i[1]),ge())}const m=M.value.find(i=>i.id===u);m&&(m.result=t.result,m.status="done",m.duration=t.duration)}I();break}case"subagent_spawn":case"subagent_report":case"subagent_done":case"subagent_error":re.value?.handleEvent(c);break;case"done":case"error":{if(c.type==="done"&&c.sessionId){const i=!x.value;x.value=c.sessionId,i&&U("session-change",c.sessionId)}const t=k.value[_];if(t.text=T.value,t.thinking=j.value||void 0,C.applyable){const i=ke(T.value);i&&(k.value.forEach(N=>{N!==t&&N.applyData&&delete N.applyData}),t.applyData=i)}const m=Ee(T.value);if(m.length>=2&&(t.options=m),c.type==="error"){c.error?.includes("no model configured")?(t.noModelError=!0,t.text=""):t.text=`[é”™è¯¯] ${c.error}`;const i=t.toolCalls?.find(N=>N.status==="running");i&&(i.status="error")}w.value=!1,T.value="",j.value="",M.value=[],U("response",t.text),I();break}}},f)}function We(){k.value=[]}function Xe(s){k.value.push(s),I()}async function Ye(s){x.value=s,k.value=[],W.value=!0;const e=s;try{const l=await ae.get(C.agentId,s);if(x.value!==e)return;const d=l.data.messages??[],_=[];d.some(r=>r.isCompact||r.role==="compaction")&&_.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const r of d)r.role!=="compaction"&&_.push({role:r.role,text:r.text,toolCalls:r.toolCalls?.map(f=>({id:f.id,name:f.name,input:f.input,result:f.result,status:"done",_expanded:!1}))});k.value=_,I(),Re(s),$e(s)}catch(l){l?.response?.status===404?k.value=[]:(console.error("[AiChat] resumeSession failed",l),k.value=[{role:"system",text:"å†å²åŠ è½½å¤±è´¥ï¼Œç»§ç»­å¯¹è¯ä»å¯æ¥ç»­"}])}finally{W.value=!1}}async function $e(s){if(w.value)return;const e=await it(C.agentId,s);if(x.value!==s||!e.hasWorker)return;if(e.status!=="generating"){const r=async()=>{if(!w.value)try{const f=await ae.get(C.agentId,s);if(w.value||x.value!==s)return;const c=f.data.messages??[],t=[];c.some(m=>m.isCompact||m.role==="compaction")&&t.push({role:"system",text:"æ›´æ—©çš„å†…å®¹å·²å‹ç¼©"});for(const m of c)m.role!=="compaction"&&t.push({role:m.role,text:m.text,toolCalls:m.toolCalls?.map(i=>({id:i.id,name:i.name,input:i.input,result:i.result,status:"done",_expanded:!1,...X(i.result??"")}))});k.value=t,I()}catch{}};await r(),setTimeout(async()=>{w.value||x.value===s&&await r()},1e3);return}if(x.value!==s)return;w.value=!0,T.value="",j.value="",M.value=[];const l={role:"assistant",text:"",toolCalls:[]};k.value.push(l);const d=k.value.length-1;I();let _="";const u=rt(C.agentId,s,r=>{switch(r.type){case"idle":k.value.splice(d,1),w.value=!1;break;case"thinking_delta":j.value+=r.text,I();break;case"text":case"text_delta":T.value+=r.text,I();break;case"tool_call":{const f={id:r.tool_call?.id??String(Date.now()),name:r.tool_call?.name??"tool",input:r.tool_call?.input?JSON.stringify(r.tool_call.input):void 0,status:"running",_startedAt:Date.now(),_expanded:!1};k.value[d].toolCalls.push(f),M.value.push(f),_=f.id,I();break}case"tool_result":{const f=k.value[d].toolCalls?.find(c=>c.id===_);if(f){f.result=r.text,f.status="done",r.text&&Object.assign(f,X(r.text));const c=M.value.find(t=>t.id===_);c&&(c.result=f.result,c.status="done",Object.assign(c,X(r.text??"")))}I();break}case"subagent_spawn":case"subagent_report":case"subagent_done":case"subagent_error":re.value?.handleEvent(r);break;case"done":case"error":{if(r.type==="done"&&r.sessionId){const c=!x.value;x.value=r.sessionId,c&&U("session-change",r.sessionId)}const f=k.value[d];f.text=T.value,f.thinking=j.value||void 0,r.type==="error"&&(r.error?.includes("no model configured")?(f.noModelError=!0,f.text=""):f.text=`[é”™è¯¯] ${r.error}`),w.value=!1,T.value="",j.value="",M.value=[],I();break}}});Se(()=>u.abort())}function Qe(){x.value=void 0,k.value=[]}function Ze(s){te(s),Y(ne)}function et(s){de(s,[],!0)}return ie({clearMessages:We,appendMessage:Xe,sendText:Ze,sendSilent:et,fillInput:te,messages:k,streaming:w,currentSessionId:x,resumeSession:Ye,startNewSession:Qe}),nt(()=>{I(),x.value&&$e(x.value)}),(s,e)=>{const l=G("ChatRound"),d=G("el-icon"),_=G("router-link"),u=G("Check"),r=G("CopyDocument"),f=G("Setting"),c=G("Paperclip");return a(),o("div",{class:A(["ai-chat",{compact:P.compact,"has-bg":P.bgColor,"drag-active":g.value}]),style:le(Me.value),onDragenter:O(qe,["prevent"]),onDragover:e[8]||(e[8]=O(()=>{},["prevent"])),onDragleave:He,onDrop:O(Ke,["prevent","stop"])},[D(oe,{name:"drag-fade"},{default:F(()=>[g.value?(a(),o("div",jt,[...e[9]||(e[9]=[n("div",{class:"drag-overlay-content"},[n("div",{class:"drag-overlay-icon"},"ğŸ“"),n("div",{class:"drag-overlay-title"},"æ¾å¼€ä»¥é™„åŠ æ–‡ä»¶"),n("div",{class:"drag-overlay-hint"},"æ”¯æŒå›¾ç‰‡ Â· ä»£ç  Â· æ–‡æœ¬æ–‡ä»¶")],-1)])])):p("",!0)]),_:1}),x.value?(a(),fe(Rt,{key:0,"session-id":x.value,ref_key:"dispatchPanelRef",ref:re},null,8,["session-id"])):p("",!0),h.value>0?(a(),o("div",At,[e[10]||(e[10]=n("span",{class:"running-dot"},null,-1)),n("span",null,"åå°æœ‰ "+v(h.value)+" ä¸ªä»»åŠ¡æ­£åœ¨æ‰§è¡Œä¸­ï¼Œå…³é—­çª—å£åä»ä¼šç»§ç»­è¿è¡Œ",1),z.value.length?(a(),o("span",Ot,[(a(!0),o(R,null,E(z.value.filter(t=>!["done","error","killed"].includes(t.status)),t=>(a(),o("span",{key:t.id,class:A(["resumed-chip",t.status])},v(t.status==="running"?"âŸ³":"ğŸŸ¡")+" "+v(t.label),3))),128))])):p("",!0)])):p("",!0),n("div",{class:"chat-messages",ref_key:"msgListRef",ref:ee},[W.value?(a(),o("div",Et,[...e[11]||(e[11]=[n("div",{class:"history-loading-dots"},[n("span"),n("span"),n("span")],-1),n("div",{class:"history-loading-text"},"åŠ è½½å†å²å¯¹è¯â€¦",-1)])])):p("",!0),!k.value.length&&!W.value?(a(),o("div",Ft,[P.welcomeMessage?(a(),o("div",Pt,v(P.welcomeMessage),1)):p("",!0),P.examples.length?(a(),o("div",Ut,[(a(!0),o(R,null,E(P.examples,(t,m)=>(a(),o("div",{key:m,class:"example-chip",onClick:i=>te(t)},v(t),9,Lt))),128))])):p("",!0)])):p("",!0),(a(!0),o(R,null,E(w.value?k.value.slice(0,-1):k.value,(t,m)=>(a(),o(R,{key:m},[t.role==="user"?(a(),o("div",Bt,[n("div",Jt,[t.images?.length?(a(),o("div",zt,[(a(!0),o(R,null,E(t.images,(i,N)=>(a(),o("img",{key:N,src:i,class:"msg-img",onClick:pe=>ue(i)},null,8,qt))),128))])):p("",!0),n("div",Ht,v(t.text),1)])])):t.role==="assistant"?(a(),o("div",Kt,[n("div",Vt,[t.thinking?(a(),o("details",{key:0,class:"thinking-block",open:P.showThinking},[n("summary",Wt,[D(d,{class:"thinking-icon"},{default:F(()=>[D(l)]),_:1}),e[12]||(e[12]=q(" æ€è€ƒè¿‡ç¨‹ ",-1)),n("span",Xt,v(t.thinking.length)+" å­—ç¬¦",1)]),n("pre",Yt,v(t.thinking),1)],8,Gt)):p("",!0),t.toolCalls?.length?(a(),o("div",Qt,[(a(!0),o(R,null,E(t.toolCalls,(i,N)=>(a(),o("div",{key:N,class:A(["tool-step",i.status]),onClick:pe=>i._expanded=!i._expanded},[n("div",es,[n("span",{class:A(["tool-step-dot",i.status])},[i.status==="running"?(a(),o("span",ts,"âŸ³")):i.status==="done"?(a(),o("span",ss,"âœ“")):i.status==="error"?(a(),o("span",ns,"âœ—")):(a(),o("span",as,"â—‹"))],2),n("span",os,v(be(i.name)),1),n("code",ls,v(i.name),1),i.input?(a(),o("span",is,v(we(i.name,i.input)),1)):p("",!0),e[14]||(e[14]=n("span",{class:"tool-step-flex"},null,-1)),i.duration?(a(),o("span",rs,v(i.duration),1)):p("",!0),i.taskId?(a(),o("span",{key:2,class:A(["task-badge",i.taskStatus])},[i.taskStatus==="pending"?(a(),o("span",us,"ğŸŸ¡ æ’é˜Ÿä¸­")):i.taskStatus==="running"?(a(),o("span",cs,[...e[13]||(e[13]=[n("span",{class:"tool-spin"},"âŸ³",-1),q(" æ‰§è¡Œä¸­ ",-1)])])):i.taskStatus==="done"?(a(),o("span",ds,"âœ… å®Œæˆ")):i.taskStatus==="error"?(a(),o("span",ps,"âŒ å¤±è´¥")):i.taskStatus==="killed"?(a(),o("span",fs,"ğŸ›‘ å·²ç»ˆæ­¢")):p("",!0)],2)):p("",!0),n("span",vs,v(i._expanded?"â–²":"â–¼"),1)]),i._expanded?(a(),o("div",{key:0,class:"tool-step-body",onClick:e[0]||(e[0]=O(()=>{},["stop"]))},[i.input?(a(),o("div",gs,[e[15]||(e[15]=n("div",{class:"tool-label"},"INPUT",-1)),n("pre",hs,v(he(i.input)),1)])):p("",!0),i.result?(a(),o("div",ms,[e[16]||(e[16]=n("div",{class:"tool-label"},"OUTPUT",-1)),n("pre",_s,v(i.result.slice(0,3e3))+v(i.result.length>3e3?`
â€¦ (æˆªæ–­)`:""),1)])):p("",!0)])):p("",!0),i.mediaUrl?(a(),o("div",{key:1,class:"tool-media-preview",onClick:e[1]||(e[1]=O(()=>{},["stop"]))},[n("img",{src:i.mediaUrl,class:"tool-media-img",onClick:pe=>ue(i.mediaUrl)},null,8,ks)])):p("",!0),i.fileCard?(a(),o("div",{key:2,class:"tool-file-card",onClick:e[2]||(e[2]=O(()=>{},["stop"]))},[n("a",{href:i.fileCard.url,target:"_blank",download:"",class:"tool-file-link"},[e[17]||(e[17]=n("span",{class:"tool-file-icon"},"ğŸ“",-1)),n("span",bs,v(i.fileCard.name),1),n("span",ws,v(i.fileCard.size),1),e[18]||(e[18]=n("span",{class:"tool-file-dl"},"â†“ ä¸‹è½½",-1))],8,ys)])):p("",!0)],10,Zt))),128))])):p("",!0),n("div",xs,[t.noModelError?(a(),o("div",Cs,[e[22]||(e[22]=n("div",{class:"no-model-icon"},"ğŸ¤–",-1)),n("div",$s,[e[20]||(e[20]=n("div",{class:"no-model-title"},"è¿˜æ²¡æœ‰é…ç½® AI æ¨¡å‹",-1)),e[21]||(e[21]=n("div",{class:"no-model-desc"},"éœ€è¦å…ˆæ·»åŠ ä¸€ä¸ªæ¨¡å‹ï¼ˆå¦‚ Claudeã€GPT-4 ç­‰ï¼‰å¹¶å¡«å†™ API Keyï¼Œæ‰èƒ½å¼€å§‹å¯¹è¯ã€‚",-1)),D(_,{to:"/models",class:"no-model-btn"},{default:F(()=>[...e[19]||(e[19]=[q("å»é…ç½®æ¨¡å‹ â†’",-1)])]),_:1})])])):t.text?(a(),o("div",{key:1,class:"msg-text",innerHTML:me(t.text)},null,8,Ss)):p("",!0),t.applyData&&C.applyable?(a(),o("div",Is,[n("div",Ts,[(a(!0),o(R,null,E(t.applyData,(i,N)=>(a(),o("div",{key:N,class:"apply-row"},[n("span",Ds,v(N),1),n("span",Ms,v(String(i).slice(0,60))+v(String(i).length>60?"â€¦":""),1)]))),128))]),n("button",{class:"apply-btn",onClick:i=>s.$emit("apply",t.applyData)}," åº”ç”¨åˆ°è¡¨å• â†™ ",8,Ns)])):p("",!0),n("div",Rs,[n("button",{class:"act-btn",onClick:i=>Ae(t.text),title:V.value===m?"å·²å¤åˆ¶":"å¤åˆ¶"},[V.value===m?(a(),fe(d,{key:0},{default:F(()=>[D(u)]),_:1})):(a(),fe(d,{key:1},{default:F(()=>[D(r)]),_:1}))],8,js),n("button",{class:"act-btn",onClick:i=>Oe(m),title:"é‡è¯•"},"â†º",8,As),C.applyable&&!t.applyData&&Fe(t.text)?(a(),o("button",{key:0,class:"act-btn apply-manual-btn",onClick:i=>Pe(t),title:"æ£€æµ‹åˆ°é…ç½® JSONï¼Œç‚¹å‡»åº”ç”¨"},[D(d,null,{default:F(()=>[D(f)]),_:1}),e[23]||(e[23]=q(" åº”ç”¨é…ç½® ",-1))],8,Os)):p("",!0)])]),t.options&&t.options.length?(a(),o("div",Es,[(a(!0),o(R,null,E(t.options,(i,N)=>(a(),o("button",{key:N,class:"option-chip",onClick:pe=>te(i)},v(i),9,Fs))),128))])):p("",!0)])])):t.role==="system"?(a(),o("div",Ps,[n("div",Us,v(t.text),1)])):p("",!0)],64))),128)),w.value?(a(),o("div",Ls,[n("div",Bs,[j.value&&P.showThinking?(a(),o("details",Js,[n("summary",zs,[D(d,{class:"thinking-icon"},{default:F(()=>[D(l)]),_:1}),e[24]||(e[24]=q(" æ€è€ƒä¸­â€¦ ",-1))]),n("pre",qs,[q(v(j.value),1),e[25]||(e[25]=n("span",{class:"blink"},"â–Š",-1))])])):p("",!0),M.value.length?(a(),o("div",Hs,[(a(!0),o(R,null,E(M.value,(t,m)=>(a(),o("div",{key:m,class:A(["tool-step",t.status]),onClick:i=>t._expanded=!t._expanded},[n("div",Vs,[n("span",{class:A(["tool-step-dot",t.status])},[t.status==="running"?(a(),o("span",Gs,"âŸ³")):t.status==="done"?(a(),o("span",Ws,"âœ“")):t.status==="error"?(a(),o("span",Xs,"âœ—")):p("",!0)],2),n("span",Ys,v(be(t.name)),1),n("code",Qs,v(t.name),1),t.input?(a(),o("span",Zs,v(we(t.name,t.input)),1)):p("",!0),e[27]||(e[27]=n("span",{class:"tool-step-flex"},null,-1)),t.duration?(a(),o("span",en,v(t.duration),1)):p("",!0),t.taskId?(a(),o("span",{key:2,class:A(["task-badge",t.taskStatus])},[t.taskStatus==="pending"?(a(),o("span",tn,"ğŸŸ¡ æ’é˜Ÿä¸­")):t.taskStatus==="running"?(a(),o("span",sn,[...e[26]||(e[26]=[n("span",{class:"tool-spin"},"âŸ³",-1),q(" æ‰§è¡Œä¸­",-1)])])):t.taskStatus==="done"?(a(),o("span",nn,"âœ… å®Œæˆ")):t.taskStatus==="error"?(a(),o("span",an,"âŒ å¤±è´¥")):t.taskStatus==="killed"?(a(),o("span",on,"ğŸ›‘ å·²ç»ˆæ­¢")):p("",!0)],2)):p("",!0),n("span",ln,v(t._expanded?"â–²":"â–¼"),1)]),t._expanded?(a(),o("div",{key:0,class:"tool-step-body",onClick:e[3]||(e[3]=O(()=>{},["stop"]))},[t.input?(a(),o("div",rn,[e[28]||(e[28]=n("div",{class:"tool-label"},"INPUT",-1)),n("pre",un,v(he(t.input)),1)])):p("",!0),t.result?(a(),o("div",cn,[e[29]||(e[29]=n("div",{class:"tool-label"},"OUTPUT",-1)),n("pre",dn,v(t.result.slice(0,3e3)),1)])):p("",!0)])):p("",!0),t.mediaUrl?(a(),o("div",{key:1,class:"tool-media-preview",onClick:e[4]||(e[4]=O(()=>{},["stop"]))},[n("img",{src:t.mediaUrl,class:"tool-media-img",onClick:i=>ue(t.mediaUrl)},null,8,pn)])):p("",!0),t.fileCard?(a(),o("div",{key:2,class:"tool-file-card",onClick:e[5]||(e[5]=O(()=>{},["stop"]))},[n("a",{href:t.fileCard.url,target:"_blank",download:"",class:"tool-file-link"},[e[30]||(e[30]=n("span",{class:"tool-file-icon"},"ğŸ“",-1)),n("span",vn,v(t.fileCard.name),1),n("span",gn,v(t.fileCard.size),1),e[31]||(e[31]=n("span",{class:"tool-file-dl"},"â†“ ä¸‹è½½",-1))],8,fn)])):p("",!0)],10,Ks))),128))])):p("",!0),T.value||!M.value.length?(a(),o("div",hn,[!T.value&&!M.value.length?(a(),o("div",mn,[...e[32]||(e[32]=[n("span",null,null,-1),n("span",null,null,-1),n("span",null,null,-1)])])):p("",!0),T.value?(a(),o("div",{key:1,class:"msg-text",innerHTML:me(T.value)},null,8,_n)):p("",!0),T.value?(a(),o("span",kn,"â–Š")):p("",!0)])):p("",!0)])])):p("",!0)],512),Z.value?(a(),o("div",{key:2,class:"img-preview-mask",onClick:e[6]||(e[6]=t=>Z.value="")},[n("img",{src:Z.value,class:"img-preview-full"},null,8,yn)])):p("",!0),n("div",bn,[B.value.length||J.value.length?(a(),o("div",wn,[(a(!0),o(R,null,E(B.value,(t,m)=>(a(),o("div",{key:"img-"+m,class:"attach-thumb"},[n("img",{src:t},null,8,xn),n("button",{class:"remove-attach",onClick:i=>Ge(m)},"Ã—",8,Cn)]))),128)),(a(!0),o(R,null,E(J.value,(t,m)=>(a(),o("div",{key:"file-"+m,class:"attach-file-chip"},[n("span",$n,v(Be(t.name)),1),n("span",Sn,v(t.name),1),n("span",In,v(Je(t.content.length)),1),n("button",{class:"attach-file-remove",onClick:i=>J.value.splice(m,1)},"Ã—",8,Tn)]))),128))])):p("",!0),n("div",Dn,[n("div",Mn,[at(n("textarea",{ref_key:"inputRef",ref:H,"onUpdate:modelValue":e[7]||(e[7]=t=>L.value=t),placeholder:P.placeholder||"è¾“å…¥æ¶ˆæ¯â€¦ æ”¯æŒæ‹–æ‹½å›¾ç‰‡æˆ–æ–‡ä»¶ (Ctrl+Enter å‘é€)",disabled:w.value||W.value,rows:"1",class:"chat-textarea",onKeydown:[Ie(O(ne,["ctrl","prevent"]),["enter"]),Ie(O(ne,["meta","prevent"]),["enter"])],onPaste:ze,onInput:je},null,40,Nn),[[ot,L.value]])]),n("div",Rn,[n("label",jn,[D(d,null,{default:F(()=>[D(c)]),_:1}),n("input",{type:"file",multiple:"",hidden:"",onChange:Ve},null,32)]),n("button",{class:"send-btn",disabled:w.value||W.value||!L.value.trim()&&!B.value.length&&!J.value.length,onClick:ne},[w.value?(a(),o("span",On)):(a(),o("span",En,"â†‘"))],8,An)])]),e[33]||(e[33]=n("div",{class:"input-hint"},"Ctrl+Enter å‘é€ Â· æ”¯æŒæ‹–æ‹½å›¾ç‰‡/æ–‡ä»¶",-1))])],38)}}}),Ln=De(Fn,[["__scopeId","data-v-1268d554"]]);export{Ln as A};
