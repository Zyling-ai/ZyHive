import{d as we,o as Ce,C as Ie,D as Ve,G as xe,H as he,z as G,c as m,e as i,b as o,w as s,y as $,f as u,F as y,p as I,l as b,g as w,x as L,r as C,I as E,h as v,i as a,m as A,J as Te,K as Q,t as _,L as X,E as V,u as $e,n as Z,M as ee,j as Ae,q as Ne,v as Ue,N as te,O as ze}from"./index-BOBEwT8C.js";import{A as le}from"./AiChat-B-3WHFEu.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Le={class:"create-layout"},Fe={class:"create-left"},Se={class:"create-header"},Oe={class:"form-section"},je={class:"color-row"},Ee=["onClick"],Be={class:"form-section"},Pe={class:"section-title"},We={key:0,class:"ai-badge"},Me={class:"form-section"},Ye={class:"form-section"},Je={class:"section-title",style:{display:"flex","align-items":"center","justify-content":"space-between"}},qe={key:0,style:{display:"flex","flex-direction":"column",gap:"6px","margin-bottom":"8px"}},He={style:{display:"flex","align-items":"center",gap:"8px"}},Ke={style:{"font-weight":"500"}},Re={key:0,style:{color:"#909399"}},Ge={key:1,class:"empty-hint"},Qe={key:2,class:"add-channel-form"},Xe={style:{display:"flex",gap:"6px",width:"100%"}},Ze={key:0,style:{color:"#67c23a","font-size":"12px","margin-top":"4px"}},et={key:1,style:{color:"#f56c6c","font-size":"12px","margin-top":"4px"}},tt={style:{display:"flex",gap:"8px","justify-content":"flex-end","margin-top":"8px"}},lt={class:"form-section"},ot={key:0,class:"empty-hint"},st={class:"form-section"},nt={key:0,class:"empty-hint"},at={class:"create-footer"},it={class:"create-right"},dt={class:"agent-tabs-bar"},rt={class:"agent-tabs-scroll"},ut=["onClick"],mt={class:"agent-tab add-tab"},pt="__config__",ft=we({__name:"AgentCreateView",setup(ct){const oe=$e(),l=L({name:"",id:"",description:"",avatarColor:"#409eff",identity:"",soul:"",modelId:"",channelIds:[],toolIds:[],skillIds:[],agentChannels:[]}),N=C(!1),d=L({type:"telegram",name:"",botToken:"",allowedFrom:"",webPassword:"",webWelcome:""}),c=L({loading:!1,status:"",botName:"",error:""});function se(){Object.assign(d,{type:"telegram",name:"",botToken:"",allowedFrom:"",webPassword:"",webWelcome:""}),Object.assign(c,{loading:!1,status:"",botName:"",error:""}),N.value=!0}async function ne(){if(d.botToken){c.loading=!0,c.status="";try{const n=l.id||"__config__",r=(await X.checkToken(n,d.botToken)).data;r.duplicate?Object.assign(c,{loading:!1,status:"duplicate",botName:"",error:`已被「${r.usedBy}」使用`}):r.valid?(Object.assign(c,{loading:!1,status:"ok",botName:r.botName||"",error:""}),!d.name&&r.botName&&(d.name=r.botName)):Object.assign(c,{loading:!1,status:"error",botName:"",error:r.error||"Token 无效"})}catch{Object.assign(c,{loading:!1,status:"error",botName:"",error:"验证失败"})}}}function ae(){const n=d.type,e={};if(n==="telegram"){if(!d.botToken){V.warning("请填写 Bot Token");return}e.botToken=d.botToken,c.botName&&(e.botName=c.botName),d.allowedFrom&&(e.allowedFrom=d.allowedFrom)}else n==="web"&&(d.webPassword&&(e.password=d.webPassword),d.webWelcome&&(e.welcome=d.webWelcome));const r=`${n}-${Date.now()}`;l.agentChannels.push({id:r,type:n,name:d.name||r,enabled:!0,config:e}),N.value=!1,V.success("已添加，保存 Agent 后生效")}function ie(n){l.agentChannels.splice(n,1)}const k=L(new Set),B={},U=C(!1),de=["#409eff","#67c23a","#e6a23c","#f56c6c","#909399","#9b59b6","#1abc9c","#e74c3c"];function P(){const n=l.name.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff\s-]/g,"").trim();let e=n.replace(/[\u4e00-\u9fff]/g,"").replace(/[\s_]+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,"");if(e.length<2){const r=Date.now().toString(36).slice(-4),p=(n.match(/[\u4e00-\u9fff]/g)||[]).length;e=p>0?`agent-${p}ch-${r}`:`agent-${r}`}l.id=e.slice(0,32)}function W(n){const e=n;l[e]=B[n]||"",k.delete(n)}function re(n){const e={name:"name",NAME:"name",id:"id",ID:"id",description:"description",DESCRIPTION:"description",desc:"description",identity:"identity",IDENTITY:"identity",soul:"soul",SOUL:"soul"};let r=0;for(const[p,g]of Object.entries(n)){const f=e[p];f&&g&&(B[p.toLowerCase()]=l[f],l[f]=g,k.add(p.toLowerCase()),p.toLowerCase()==="name"&&P(),r++)}r>0?V.success(`已填入 ${r} 个字段到左侧表单 ✓`):V.warning("未识别到可填入的字段，请手动复制")}async function ue(){if(!l.name.trim()){V.warning("请填写名称");return}if(!l.id.trim()||l.id==="-"||!/^[a-z0-9][a-z0-9-_]{0,30}$/.test(l.id)){V.warning("ID 格式不对，请手动填写（只能用小写字母、数字、连字符）");return}if(!U.value){U.value=!0;try{await G.create({...l,model:l.modelId||""});const n=[];if(l.identity.trim()&&n.push(te.write(l.id,"IDENTITY.md",l.identity)),l.soul.trim()&&n.push(te.write(l.id,"SOUL.md",l.soul)),n.length&&await Promise.all(n),l.agentChannels.length)try{await X.set(l.id,l.agentChannels)}catch{}try{await ze.setConfig(l.id,{enabled:!0,schedule:"daily",keepTurns:3,focusHint:"",cronJobId:""})}catch{}V.success("Agent 创建成功！"),oe.push(`/agents/${l.id}`)}catch(n){V.error(n.response?.data?.error||"创建失败")}finally{U.value=!1}}}const z=C([]),me=C([]),F=C([]),S=C([]),O=C([]),x=C("__assist__"),h=C([]),M=E(()=>O.value.filter(n=>h.value.includes(n.id))),Y=E(()=>O.value.filter(n=>!h.value.includes(n.id))),pe=E(()=>["你是一个 AI 配置助手，帮助用户设计和生成 AI Agent 的配置文件（IDENTITY 和 SOUL）。","用户正在新建一个 Agent，当前表单状态如下（未填字段为空）：",`- 名称: ${l.name||"（未填）"}`,`- ID: ${l.id||"（未填）"}`,`- 描述: ${l.description||"（未填）"}`,l.identity?`- IDENTITY（已填）: ${l.identity.slice(0,100)}...`:"- IDENTITY: （未填）",l.soul?`- SOUL（已填）: ${l.soul.slice(0,100)}...`:"- SOUL: （未填）","","当你为用户生成配置时，请在回答末尾附上如下格式的 JSON 块，方便用户一键应用：","```json",'{"name":"...","description":"...","identity":"...","soul":"..."}',"```","如果某个字段不需要更改，就省略它。"].join(`
`));function D(n){x.value=n}function fe(n){h.value.includes(n)||h.value.push(n),D(n)}function ce(n){h.value=h.value.filter(e=>e!==n),x.value===n&&D("__assist__")}return Ce(async()=>{const[n,e,r,p,g]=await Promise.allSettled([Ie.list(),Ve.list(),xe.list(),he.list(),G.list()]);n.status==="fulfilled"&&(z.value=n.value.data),e.status==="fulfilled"&&(me.value=e.value.data),r.status==="fulfilled"&&(F.value=r.value.data),p.status==="fulfilled"&&(S.value=p.value.data),g.status==="fulfilled"&&(O.value=g.value.data),z.value.length>0&&(l.modelId=z.value[0]?.id??"")}),(n,e)=>{const r=v("el-icon"),p=v("el-button"),g=v("el-input"),f=v("el-form-item"),j=v("el-option"),J=v("el-select"),ge=v("el-tag"),q=v("el-form"),ve=v("el-link"),H=v("el-checkbox"),K=v("el-checkbox-group"),ye=v("el-text"),be=v("User"),R=v("el-dropdown-item"),_e=v("el-dropdown-menu"),ke=v("el-dropdown");return a(),m("div",Le,[i("div",Fe,[i("div",Se,[o(p,{text:"",onClick:e[0]||(e[0]=t=>n.$router.push("/agents")),class:"back-btn"},{default:s(()=>[o(r,null,{default:s(()=>[o(A(Te))]),_:1}),e[23]||(e[23]=u(" 返回 ",-1))]),_:1}),e[24]||(e[24]=i("h2",{style:{margin:"0"}},"新建 AI 成员",-1))]),o(q,{model:l,"label-position":"top",class:"create-form"},{default:s(()=>[i("div",Oe,[e[25]||(e[25]=i("div",{class:"section-title"},"基本信息",-1)),o(f,{label:"名称",required:""},{default:s(()=>[o(g,{modelValue:l.name,"onUpdate:modelValue":e[1]||(e[1]=t=>l.name=t),placeholder:"如：电商客服助手",onInput:P},null,8,["modelValue"])]),_:1}),o(f,{label:"ID"},{default:s(()=>[o(g,{modelValue:l.id,"onUpdate:modelValue":e[2]||(e[2]=t=>l.id=t),placeholder:"英文标识（自动生成）"},null,8,["modelValue"])]),_:1}),o(f,{label:"描述"},{default:s(()=>[o(g,{modelValue:l.description,"onUpdate:modelValue":e[3]||(e[3]=t=>l.description=t),type:"textarea",rows:2,placeholder:"简短描述这个 Agent 的职责"},null,8,["modelValue"])]),_:1}),o(f,{label:"头像颜色"},{default:s(()=>[i("div",je,[(a(),m(y,null,I(de,t=>i("div",{key:t,class:$(["color-swatch",{active:l.avatarColor===t}]),style:Z({background:t}),onClick:T=>l.avatarColor=t},null,14,Ee)),64))])]),_:1})]),i("div",Be,[i("div",Pe,[e[26]||(e[26]=u(" 身份 & 灵魂 ",-1)),k.has("identity")||k.has("soul")?(a(),m("span",We,"AI 生成")):w("",!0)]),o(f,null,{label:s(()=>[e[28]||(e[28]=i("span",null,[u("IDENTITY "),i("span",{class:"field-hint"},"— 角色定义")],-1)),k.has("identity")?(a(),b(p,{key:0,text:"",size:"small",onClick:e[4]||(e[4]=t=>W("identity")),class:"revert-btn"},{default:s(()=>[...e[27]||(e[27]=[u("↺ 撤销",-1)])]),_:1})):w("",!0)]),default:s(()=>[o(g,{modelValue:l.identity,"onUpdate:modelValue":e[5]||(e[5]=t=>l.identity=t),type:"textarea",rows:5,class:$({"ai-filled":k.has("identity")}),placeholder:"你是一个...（描述 Agent 的角色和能力）",onInput:e[6]||(e[6]=t=>k.delete("identity"))},null,8,["modelValue","class"])]),_:1}),o(f,null,{label:s(()=>[e[30]||(e[30]=i("span",null,[u("SOUL "),i("span",{class:"field-hint"},"— 行为风格")],-1)),k.has("soul")?(a(),b(p,{key:0,text:"",size:"small",onClick:e[7]||(e[7]=t=>W("soul")),class:"revert-btn"},{default:s(()=>[...e[29]||(e[29]=[u("↺ 撤销",-1)])]),_:1})):w("",!0)]),default:s(()=>[o(g,{modelValue:l.soul,"onUpdate:modelValue":e[8]||(e[8]=t=>l.soul=t),type:"textarea",rows:5,class:$({"ai-filled":k.has("soul")}),placeholder:"语气亲切，回答简洁...（描述 Agent 的个性风格）",onInput:e[9]||(e[9]=t=>k.delete("soul"))},null,8,["modelValue","class"])]),_:1})]),i("div",Me,[e[31]||(e[31]=i("div",{class:"section-title"},"模型",-1)),o(f,{label:"选择模型"},{default:s(()=>[o(J,{modelValue:l.modelId,"onUpdate:modelValue":e[10]||(e[10]=t=>l.modelId=t),placeholder:"选择模型",style:{width:"100%"}},{default:s(()=>[(a(!0),m(y,null,I(z.value,t=>(a(),b(j,{key:t.id,label:`${t.name}（${t.provider}）`,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),i("div",Ye,[i("div",Je,[e[33]||(e[33]=i("span",null,"消息通道",-1)),o(p,{size:"small",type:"primary",plain:"",onClick:se},{default:s(()=>[o(r,null,{default:s(()=>[o(A(Q))]),_:1}),e[32]||(e[32]=u(" 添加 ",-1))]),_:1})]),l.agentChannels.length?(a(),m("div",qe,[(a(!0),m(y,null,I(l.agentChannels,(t,T)=>(a(),m("div",{key:T,style:{display:"flex","align-items":"center","justify-content":"space-between",padding:"6px 10px",background:"#f5f7fa","border-radius":"6px","font-size":"13px"}},[i("div",He,[o(ge,{size:"small"},{default:s(()=>[u(_(t.type==="telegram"?"Telegram":"Web"),1)]),_:2},1024),i("span",Ke,_(t.name||"未命名"),1),t.config?.botName?(a(),m("span",Re,"@"+_(t.config.botName),1)):w("",!0)]),o(p,{text:"",size:"small",type:"danger",onClick:gt=>ie(T)},{default:s(()=>[o(r,null,{default:s(()=>[o(A(ee))]),_:1})]),_:1},8,["onClick"])]))),128))])):(a(),m("div",Ge,"暂未添加通道（可在创建后配置）")),N.value?(a(),m("div",Qe,[o(q,{model:d,"label-width":"90px",size:"small"},{default:s(()=>[o(f,{label:"类型"},{default:s(()=>[o(J,{modelValue:d.type,"onUpdate:modelValue":e[11]||(e[11]=t=>d.type=t),style:{width:"100%"}},{default:s(()=>[o(j,{label:"Telegram",value:"telegram"}),o(j,{label:"Web 聊天页",value:"web"})]),_:1},8,["modelValue"])]),_:1}),o(f,{label:"名称"},{default:s(()=>[o(g,{modelValue:d.name,"onUpdate:modelValue":e[12]||(e[12]=t=>d.name=t),placeholder:"如：客服 Bot"},null,8,["modelValue"])]),_:1}),d.type==="telegram"?(a(),m(y,{key:0},[o(f,{label:"Bot Token"},{default:s(()=>[i("div",Xe,[o(g,{modelValue:d.botToken,"onUpdate:modelValue":e[13]||(e[13]=t=>d.botToken=t),type:"password","show-password":"",placeholder:"从 @BotFather 获取",style:{flex:"1"},status:c.status==="error"?"error":c.status==="ok"?"success":""},null,8,["modelValue","status"]),o(p,{size:"small",loading:c.loading,onClick:ne},{default:s(()=>[...e[34]||(e[34]=[u("验证",-1)])]),_:1},8,["loading"])]),c.status==="ok"?(a(),m("div",Ze," ✓ Token 有效，Bot：@"+_(c.botName),1)):c.status==="error"?(a(),m("div",et," ✗ "+_(c.error),1)):w("",!0)]),_:1}),o(f,{label:"白名单 ID"},{default:s(()=>[o(g,{modelValue:d.allowedFrom,"onUpdate:modelValue":e[14]||(e[14]=t=>d.allowedFrom=t),placeholder:"Telegram 用户 ID，多个用逗号分隔（留空=配对模式）"},null,8,["modelValue"])]),_:1})],64)):w("",!0),d.type==="web"?(a(),m(y,{key:1},[o(f,{label:"访问密码"},{default:s(()=>[o(g,{modelValue:d.webPassword,"onUpdate:modelValue":e[15]||(e[15]=t=>d.webPassword=t),type:"password","show-password":"",placeholder:"留空则无需密码"},null,8,["modelValue"])]),_:1}),o(f,{label:"欢迎语"},{default:s(()=>[o(g,{modelValue:d.webWelcome,"onUpdate:modelValue":e[16]||(e[16]=t=>d.webWelcome=t),placeholder:"你好！有什么可以帮你的？"},null,8,["modelValue"])]),_:1})],64)):w("",!0)]),_:1},8,["model"]),i("div",tt,[o(p,{size:"small",onClick:e[17]||(e[17]=t=>N.value=!1)},{default:s(()=>[...e[35]||(e[35]=[u("取消",-1)])]),_:1}),o(p,{size:"small",type:"primary",onClick:ae},{default:s(()=>[...e[36]||(e[36]=[u("确认添加",-1)])]),_:1})])])):w("",!0)]),i("div",lt,[e[40]||(e[40]=i("div",{class:"section-title"},"开启能力",-1)),F.value.length===0?(a(),m("div",ot,[e[38]||(e[38]=u(" 暂无能力，先在",-1)),o(ve,{onClick:e[18]||(e[18]=t=>n.$router.push("/config/tools")),type:"primary"},{default:s(()=>[...e[37]||(e[37]=[u(" 全局配置 ",-1)])]),_:1}),e[39]||(e[39]=u("添加 ",-1))])):(a(),b(K,{key:1,modelValue:l.toolIds,"onUpdate:modelValue":e[19]||(e[19]=t=>l.toolIds=t)},{default:s(()=>[(a(!0),m(y,null,I(F.value,t=>(a(),b(H,{key:t.id,label:t.id,value:t.id},{default:s(()=>[u(_(t.name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]))]),i("div",st,[e[41]||(e[41]=i("div",{class:"section-title"},"Skills",-1)),S.value.length===0?(a(),m("div",nt,"暂无已安装的 Skills")):(a(),b(K,{key:1,modelValue:l.skillIds,"onUpdate:modelValue":e[20]||(e[20]=t=>l.skillIds=t)},{default:s(()=>[(a(!0),m(y,null,I(S.value,t=>(a(),b(H,{key:t.id,label:t.id,value:t.id},{default:s(()=>[u(_(t.name)+" ",1),o(ye,{type:"info",size:"small",style:{"margin-left":"4px"}},{default:s(()=>[u("v"+_(t.version),1)]),_:2},1024)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"]))])]),_:1},8,["model"]),i("div",at,[o(p,{onClick:e[21]||(e[21]=t=>n.$router.push("/agents"))},{default:s(()=>[...e[42]||(e[42]=[u("取消",-1)])]),_:1}),o(p,{type:"primary",loading:U.value,onClick:ue},{default:s(()=>[...e[43]||(e[43]=[u(" 保存 Agent ",-1)])]),_:1},8,["loading"])])]),i("div",it,[i("div",dt,[i("div",rt,[i("div",{class:$(["agent-tab",{active:x.value==="__assist__"}]),onClick:e[22]||(e[22]=t=>D("__assist__"))},[o(r,{class:"tab-icon"},{default:s(()=>[o(be)]),_:1}),e[44]||(e[44]=u(" 配置助手 ",-1))],2),(a(!0),m(y,null,I(M.value,t=>(a(),m("div",{key:t.id,class:$(["agent-tab",{active:x.value===t.id}]),onClick:T=>D(t.id)},[i("div",{class:"tab-avatar",style:Z({background:t.avatarColor||"#409eff"})},_(t.name.charAt(0)),5),u(" "+_(t.name)+" ",1),o(r,{class:"tab-close",onClick:Ae(T=>ce(t.id),["stop"])},{default:s(()=>[o(A(ee))]),_:1},8,["onClick"])],10,ut))),128)),o(ke,{onCommand:fe,trigger:"click"},{dropdown:s(()=>[o(_e,null,{default:s(()=>[(a(!0),m(y,null,I(Y.value,t=>(a(),b(R,{key:t.id,command:t.id},{default:s(()=>[u(_(t.name),1)]),_:2},1032,["command"]))),128)),Y.value.length===0?(a(),b(R,{key:0,disabled:""},{default:s(()=>[...e[46]||(e[46]=[u("暂无其他 Agent",-1)])]),_:1})):w("",!0)]),_:1})]),default:s(()=>[i("div",mt,[o(r,null,{default:s(()=>[o(A(Q))]),_:1}),e[45]||(e[45]=u(" 更多",-1))])]),_:1})])]),x.value==="__assist__"?(a(),m(y,{key:0},[(a(),b(le,{key:0,"agent-id":pt,context:pe.value,scenario:"agent-creation",placeholder:"告诉我这个 Agent 要做什么...",examples:["我需要一个电商客服 Agent，负责解答订单问题，语气亲切","帮我创建一个代码审查助手，专注于 Python 代码规范","创建一个每天早上发送天气报告的 Agent"],height:"100%",compact:!0,"show-thinking":!0,applyable:!0,onApply:re},null,8,["context"]))],64)):w("",!0),(a(!0),m(y,null,I(M.value,t=>Ne((a(),b(le,{key:t.id,"agent-id":t.id,scenario:"general","welcome-message":`你好，我是 **${t.name}**，有什么需要帮忙的？`,height:"100%",compact:!0,"show-thinking":!0},null,8,["agent-id","welcome-message"])),[[Ue,x.value===t.id]])),128))])])}}}),_t=De(ft,[["__scopeId","data-v-4f9c6568"]]);export{_t as default};
